---
title: "Understanding Dataset"
author: "Singh Sivaram, Aakash"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, comment = NA)
```

```{r init, include=F}
# include all your packages here
library(ezids)
library(data.table)
source("./HelperFunctions/fetchSubset.R")
```
```{r}
# all file paths
df_file_path = "../DataSet/filtered_accepted_2013_to_2018Q4.csv"

```

# Inspecting Dataset

```{r}
# Load Dataset
df_100 <- fetch_subset(df_file_path, col_names = c(-1), nrows = c(1, 100), chunk_size = 1e5)

```

## List of Column names 

```{r}
col_names <- names(df_100)
print(sort(col_names))
```
## \# of Observations

```{r}
nrows <- nrow(fread(df_file_path, select = 1, header = TRUE))
print(nrows)

```

## variables

```{r}
columns_to_target = c("annual_inc", "dti", "fico_range_high", "fico_range_low", "loan_amnt", 
  "int_rate", "earliest_cr_line", "revol_util", "delinq_2yrs", "pub_rec", 
  "total_acc", "open_acc", "installment", "home_ownership", 
  "verification_status", "delinq_amnt", "collections_12_mths_ex_med", 
  "chargeoff_within_12_mths", "mths_since_last_delinq", "purpose", "sub_grade", "issue_d", "addr_state","inq_last_12m","loan_status")


df <- fetch_subset(df_location = df_file_path, col_names = columns_to_target, nrows = c(1,-1))

```

```{r}
str(df)
```

```{r}
convert_to_factors <- function(df) {
  # Columns to convert to factors based on the provided list
  factor_cols <- c("home_ownership", "verification_status", 
                   "loan_status", "purpose", "addr_state","sub_grade")
  
  df[] <- lapply(names(df), function(col) {
    if (col %in% factor_cols) {
      return(as.factor(df[[col]]))
    } else if (is.character(df[[col]]) && all(!is.na(as.numeric(df[[col]][-1])))) {
      return(as.numeric(df[[col]]))
    } else {
      return(df[[col]])
    }
  })
  
  return(df)
}
df <- df[-1,]
df <- convert_to_factors(df)
str(df)
```


```{r}
# Convert specified columns to numeric

df$revol_util <- as.numeric(df$revol_util)
df$mths_since_last_delinq <- as.numeric(df$mths_since_last_delinq)
df$dti <- as.numeric(df$dti)
df$inq_last_12m <- as.numeric(df$inq_last_12m)


# Optional: Check for any warnings about NAs being introduced during coercion
if (any(is.na(df$revol_util))) {
  warning("NAs introduced in 'revol_util' during conversion.")
}
if (any(is.na(df$mths_since_last_delinq))) {
  warning("NAs introduced in 'mths_since_last_delinq' during conversion.")
}
if (any(is.na(df$dti))) {
  warning("NAs introduced in 'dti' during conversion.")
}

```
```{r}
str(df)
```

```{r}
# Count the number of NA values in each column
na_counts <- sapply(df, function(x) sum(is.na(x)))

# Print the counts of NA values
print(na_counts)

```

```{r}
# Load necessary libraries
library(corrplot)
setDT(df)  # Converts df to a data.table, if it isn't one already

# Select only numeric columns from the data table
numeric_df <- df[, .SD, .SDcols = sapply(df, is.numeric)]

# Calculate the correlation matrix
cor_matrix <- cor(numeric_df, use = "pairwise.complete.obs")

# Set plotting parameters for larger plot size
#par(cex.axis = 3, cex.lab = 3, cex.main = 3)  # Increase text size

# Create a larger plot window
options(repr.plot.width = 35, repr.plot.height = 35)  # Use this in RMarkdown or Jupyter Notebooks

# Plot the correlation matrix using corrplot
#png(filename = "mycorrplot.png", width = 1200, height = 800)
# Set plotting parameters for larger text size
corrplot(cor_matrix,
         type = "upper", 
         method = "circle", 
         addCoef.col = 0.2,  # Color for coefficients
         number.cex = 0.1,  # Size of the correlation coefficients
         tl.cex = 0.6,      # Size of the text labels for variables
         tl.col = "black",  # Color of the text labels
         cl.cex = 0.5,      # Size of the color legend text
         main = "Correlation Matrix",  # Title of the plot
         main.cex = 0.1)      # Size of the title text

# Close the device
#dev.off()
```

```{r}
# Load necessary libraries
library(lubridate)
library(dplyr)
library(ggplot2)



#Filter out rows with NA values in year or quarter
df <- df %>%
  filter(!is.na(year), !is.na(quarter))

#Calculate the total number of loans per quarter
df_total_per_quarter <- df %>%
  group_by(year, quarter) %>%
  summarise(total_loans = n()) %>%
  ungroup()

#Filter for 'Charged Off' loan status
df_charged_off <- df %>%
  filter(loan_status == "Charged Off")

#Aggregate 'Charged Off' counts by year and quarter
df_charged_off_aggregated <- df_charged_off %>%
  group_by(year, quarter) %>%
  summarise(charged_off_count = n()) %>%
  ungroup()

#Merge the total loan counts with the 'Charged Off' counts
df_merged <- df_charged_off_aggregated %>%
  left_join(df_total_per_quarter, by = c("year", "quarter")) %>%
  mutate(percentage = (charged_off_count / total_loans) * 100)

#Create a Year-Quarter variable in the correct format and order
df_merged <- df_merged %>%
  mutate(Year_Quarter = paste0(year, ".", quarter)) %>%
  arrange(year, quarter)  # Arrange the data to ensure it's in the correct order

#Convert Year_Quarter into a factor with levels in the correct chronological order
df_merged$Year_Quarter <- factor(df_merged$Year_Quarter, 
                                 levels = df_merged$Year_Quarter)

#Create the line plot with percentage and display percentage as text on each point
ggplot(df_merged, aes(x = Year_Quarter, y = percentage, group = 1)) +
  geom_line(color = "red", size = 1) +
  geom_point(color = "red", size = 2) +
  geom_text(aes(label = sprintf("%.1f%%", percentage)), vjust = -1, size = 3.5) +  # Display percentage above points
  labs(x = "Year-Quarter", y = "Charged Off Percentage", title = "Percentage of Charged Off Loans by Year and Quarter") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


